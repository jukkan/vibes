<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SUOMIR√ÑP BATTLE - Finnish Rap Battle Game</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- noUiSlider for year range filter -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/nouislider/15.7.1/nouislider.min.css">
    <style>
        :root {
            --finland-blue: #003580;
            --finland-white: #ffffff;
            --bg-dark: #111827;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--finland-white);
            min-height: 100vh;
        }

        /* Finnish flag accent stripe */
        .finland-stripe {
            background: linear-gradient(90deg, var(--finland-blue) 0%, var(--finland-blue) 100%);
            height: 4px;
        }

        /* Track card styling */
        .track-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            transition: all 0.3s ease;
            min-height: 420px;
        }

        .track-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 53, 128, 0.3);
            border-color: var(--finland-blue);
        }

        /* Album art container */
        .album-container {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            cursor: pointer;
        }

        .album-art {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .album-container:hover .album-art {
            transform: scale(1.05);
        }

        /* Play overlay */
        .play-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .album-container:hover .play-overlay {
            opacity: 1;
        }

        .play-btn {
            width: 64px;
            height: 64px;
            background: var(--finland-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease;
        }

        .play-btn:hover {
            transform: scale(1.1);
        }

        /* Vote button */
        .vote-btn {
            background: var(--finland-blue);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .vote-btn:hover {
            background: #004db3;
            transform: scale(1.02);
        }

        .vote-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* VS divider */
        .vs-divider {
            font-size: 48px;
            font-weight: 900;
            color: var(--finland-blue);
            text-shadow: 0 0 20px rgba(0, 53, 128, 0.5);
        }

        /* Winner badge */
        .winner-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #111;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 800;
            font-size: 14px;
            animation: winner-pulse 0.6s ease-out;
            z-index: 10;
        }

        @keyframes winner-pulse {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Popularity score reveal */
        .popularity-score {
            font-size: 48px;
            font-weight: 900;
            background: linear-gradient(135deg, #fff, rgba(255, 255, 255, 0.7));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: score-reveal 0.5s ease-out;
        }

        @keyframes score-reveal {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Confetti container */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confetti-fall 3s ease-out forwards;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Loading spinner */
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--finland-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Stats panel */
        .stats-panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
        }

        /* Keyboard hint */
        .key-hint {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            margin-right: 8px;
        }

        /* Audio player hidden */
        audio {
            display: none;
        }

        /* Tie message */
        .tie-badge {
            background: linear-gradient(135deg, #9333ea, #6366f1);
            color: white;
            padding: 12px 24px;
            border-radius: 20px;
            font-weight: 700;
            animation: tie-pulse 0.6s ease-out;
        }

        @keyframes tie-pulse {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Spotify link */
        .spotify-link {
            color: #1DB954;
            text-decoration: none;
            font-size: 12px;
            transition: color 0.2s;
        }

        .spotify-link:hover {
            color: #1ed760;
            text-decoration: underline;
        }

        /* Info tooltip */
        .info-bubble {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            font-size: 12px;
            cursor: pointer;
            margin-left: 6px;
            vertical-align: middle;
            transition: background 0.2s;
        }

        .info-bubble:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Info modal */
        .info-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
            animation: fade-in 0.2s ease;
        }

        .info-modal.hidden {
            display: none;
        }

        .info-content {
            background: #1f2937;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            text-align: left;
        }

        .info-content h3 {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 12px;
            color: white;
        }

        .info-content p {
            font-size: 14px;
            color: #9ca3af;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .info-content ul {
            font-size: 14px;
            color: #9ca3af;
            margin-left: 20px;
            margin-bottom: 16px;
        }

        .info-content li {
            margin-bottom: 6px;
        }

        .info-close {
            background: var(--finland-blue);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }

        .info-close:hover {
            background: #004db3;
        }

        @keyframes fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Year slider styling */
        .year-filter-container {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 24px;
        }

        .year-filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .year-filter-title {
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
        }

        .year-range-display {
            font-size: 18px;
            font-weight: 700;
            color: white;
        }

        .track-count {
            font-size: 13px;
            color: #9ca3af;
            margin-top: 12px;
            text-align: center;
        }

        .track-count.warning {
            color: #f87171;
        }

        /* noUiSlider customization */
        .noUi-target {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 4px;
            height: 8px;
        }

        .noUi-connect {
            background: var(--finland-blue);
        }

        .noUi-handle {
            width: 20px !important;
            height: 20px !important;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--finland-blue);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            cursor: grab;
            top: -7px !important;
            right: -10px !important;
        }

        .noUi-handle:before,
        .noUi-handle:after {
            display: none;
        }

        .noUi-handle:active {
            cursor: grabbing;
        }

        .noUi-tooltip {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-900">
    <!-- Finnish flag accent stripe at top -->
    <div class="finland-stripe"></div>

    <!-- Header -->
    <header class="py-6 px-4 text-center">
        <a href="/" class="text-blue-400 text-sm hover:underline mb-4 inline-block">‚Üê vibes</a>
        <h1 class="text-4xl md:text-5xl font-black mb-2">
            SUOMIR√ÑP BATTLE <span class="text-3xl">üî•</span>
        </h1>
        <p class="text-gray-400 text-lg">Vote for your favorite Finnish hip-hop track!</p>
        <p class="text-gray-500 text-sm mt-2">Press <span class="key-hint">1</span> or <span class="key-hint">2</span> to vote ‚Ä¢ Click album art to listen on Spotify</p>
    </header>

    <!-- Main content -->
    <main class="max-w-6xl mx-auto px-4 pb-12">
        <!-- Loading state -->
        <div id="loadingSection" class="flex flex-col items-center justify-center py-20">
            <div class="spinner mb-4"></div>
            <p class="text-gray-400" id="loadingMessage">Connecting to Spotify...</p>
        </div>

        <!-- Error state -->
        <div id="errorSection" class="hidden text-center py-20">
            <div class="text-6xl mb-4">üò¢</div>
            <h2 class="text-2xl font-bold mb-2 text-red-400" id="errorTitle">Could not connect to Spotify</h2>
            <p class="text-gray-400 mb-6" id="errorMessage">Please try again later.</p>
            <button onclick="location.reload()" class="vote-btn max-w-xs">Try Again</button>
        </div>

        <!-- Battle arena -->
        <div id="battleSection" class="hidden">
            <!-- Year filter slider -->
            <div class="year-filter-container max-w-2xl mx-auto">
                <div class="year-filter-header">
                    <span class="year-filter-title">Release Year</span>
                    <span id="yearRangeDisplay" class="year-range-display">1990 - 2024</span>
                </div>
                <div id="yearSlider"></div>
                <p id="trackCount" class="track-count">Loading tracks...</p>
            </div>

            <!-- Battle grid -->
            <div class="grid grid-cols-1 md:grid-cols-[1fr_auto_1fr] gap-6 items-center mb-8">
                <!-- Track 1 -->
                <div id="track1Container" class="track-card p-6 relative">
                    <div class="album-container mb-4" id="album1Container">
                        <img id="album1" src="" alt="Album art" class="album-art">
                        <div class="play-overlay" id="playOverlay1">
                            <div class="play-btn" title="Play on Spotify">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                                    <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <h3 id="title1" class="text-xl font-bold mb-1 truncate"></h3>
                    <p id="artist1" class="text-gray-400 mb-2 truncate"></p>
                    <a id="spotifyLink1" href="#" target="_blank" class="spotify-link mb-4 inline-block">
                        üéß Listen on Spotify
                    </a>
                    <div id="score1Container" class="hidden text-center my-4">
                        <p class="text-sm text-gray-400 mb-1">
                            Popularity Score
                            <span class="info-bubble" onclick="showInfoModal()" title="How is this calculated?">?</span>
                        </p>
                        <div id="score1" class="popularity-score"></div>
                    </div>
                    <button id="voteBtn1" class="vote-btn mt-4" onclick="vote(1)">
                        <span class="key-hint">1</span> Vote for this track
                    </button>
                </div>

                <!-- VS divider -->
                <div class="hidden md:flex flex-col items-center justify-center py-8">
                    <div class="vs-divider">VS</div>
                </div>
                <div class="md:hidden text-center py-4">
                    <div class="vs-divider text-3xl">VS</div>
                </div>

                <!-- Track 2 -->
                <div id="track2Container" class="track-card p-6 relative">
                    <div class="album-container mb-4" id="album2Container">
                        <img id="album2" src="" alt="Album art" class="album-art">
                        <div class="play-overlay" id="playOverlay2">
                            <div class="play-btn" title="Play on Spotify">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                                    <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                    <h3 id="title2" class="text-xl font-bold mb-1 truncate"></h3>
                    <p id="artist2" class="text-gray-400 mb-2 truncate"></p>
                    <a id="spotifyLink2" href="#" target="_blank" class="spotify-link mb-4 inline-block">
                        üéß Listen on Spotify
                    </a>
                    <div id="score2Container" class="hidden text-center my-4">
                        <p class="text-sm text-gray-400 mb-1">
                            Popularity Score
                            <span class="info-bubble" onclick="showInfoModal()" title="How is this calculated?">?</span>
                        </p>
                        <div id="score2" class="popularity-score"></div>
                    </div>
                    <button id="voteBtn2" class="vote-btn mt-4" onclick="vote(2)">
                        <span class="key-hint">2</span> Vote for this track
                    </button>
                </div>
            </div>

            <!-- Battle again button (hidden until vote) -->
            <div id="battleAgainContainer" class="hidden text-center mb-8">
                <button id="battleAgainBtn" class="vote-btn max-w-md" onclick="startNewBattle()">
                    üî• Battle Again
                </button>
            </div>

            <!-- User stats panel -->
            <div id="statsPanel" class="stats-panel max-w-md mx-auto hidden">
                <h3 class="text-lg font-bold mb-3">üìä Your Stats</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="text-gray-400">Battles</p>
                        <p id="statBattles" class="text-2xl font-bold">0</p>
                    </div>
                    <div>
                        <p class="text-gray-400">Favorite Artist</p>
                        <p id="statFavorite" class="text-lg font-bold truncate">-</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="py-6 text-center text-gray-500 text-sm border-t border-gray-800">
        <a href="/" class="text-blue-400 hover:underline">‚Üê Back to launcher</a> |
        <a href="https://github.com/jukkan/vibes" class="text-blue-400 hover:underline">View source</a>
        <p class="mt-2">Powered by Spotify Web API</p>
    </footer>

    <!-- Info modal -->
    <div id="infoModal" class="info-modal hidden" onclick="hideInfoModal(event)">
        <div class="info-content" onclick="event.stopPropagation()">
            <h3>üìä How Popularity Score Works</h3>
            <p>
                The popularity score (0-100) comes directly from Spotify's API and reflects how popular a track is on their platform.
            </p>
            <p><strong>Spotify calculates it based on:</strong></p>
            <ul>
                <li>Total number of plays the track has</li>
                <li>How recent those plays are</li>
                <li>Tracks with more recent streams score higher</li>
            </ul>
            <p>
                A track's popularity can change daily as new streaming data comes in. Scores above 70 are considered popular, while under 30 is more niche.
            </p>
            <button class="info-close" onclick="hideInfoModal()">Got it!</button>
        </div>
    </div>

    <!-- Confetti container -->
    <div id="confettiContainer" class="confetti-container"></div>

    <!-- noUiSlider JS - must load before main script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nouislider/15.7.1/nouislider.min.js"></script>

    <script>
        /**
         * SUOMIR√ÑP BATTLE - Finnish Rap Battle Game
         *
         * SPOTIFY API TOKEN FLOW:
         * 1. On page load, we request an access token using Client Credentials flow
         * 2. POST to https://accounts.spotify.com/api/token with client_id & client_secret
         * 3. Token is valid for 1 hour (3600 seconds)
         * 4. We store the token in memory (not localStorage for security)
         * 5. If token expires during session, we automatically refresh it
         *
         * SEARCH ENDPOINT:
         * GET https://api.spotify.com/v1/search
         * - q: genre:finnish%20hip%20hop (search query)
         * - type: track (we only want tracks)
         * - market: FI (Finnish market for relevance)
         * - limit: 50 (max per request)
         *
         * We filter results to only include tracks with preview_url (30s audio previews)
         */

        // Spotify API credentials
        const CLIENT_ID = '3ab27f76b0b84800b7e39267cf999b57';
        const CLIENT_SECRET = '15797ed778a84e3f9251929ea3ded3cc';
        const TOKEN_ENDPOINT = 'https://accounts.spotify.com/api/token';
        const SEARCH_ENDPOINT = 'https://api.spotify.com/v1/search';

        // App state
        let accessToken = null;
        let tokenExpiresAt = null;
        let allTracks = [];       // All tracks from API (with year parsed)
        let filteredTracks = [];  // Tracks filtered by year range
        let currentTrack1 = null;
        let currentTrack2 = null;
        let battleEnded = false;
        let currentlyPlaying = null;
        let yearSlider = null;
        let currentYearMin = 1990;
        let currentYearMax = 2024;

        // Stats tracking (stored in localStorage)
        let userStats = {
            battles: 0,
            artistVotes: {} // { artistName: voteCount }
        };

        // DOM elements
        const loadingSection = document.getElementById('loadingSection');
        const errorSection = document.getElementById('errorSection');
        const battleSection = document.getElementById('battleSection');
        const loadingMessage = document.getElementById('loadingMessage');

        /**
         * Fetch Spotify access token using Client Credentials flow
         * Token is valid for 3600 seconds (1 hour)
         */
        async function getAccessToken() {
            console.log('Fetching Spotify access token...');

            try {
                const response = await fetch(TOKEN_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `grant_type=client_credentials&client_id=${CLIENT_ID}&client_secret=${CLIENT_SECRET}`
                });

                if (!response.ok) {
                    console.error('Token fetch failed:', response.status, response.statusText);
                    throw new Error('Failed to get access token');
                }

                const data = await response.json();
                console.log('Token response:', data);

                accessToken = data.access_token;
                // Set expiry time (subtract 60s buffer for safety)
                tokenExpiresAt = Date.now() + (data.expires_in - 60) * 1000;

                return accessToken;
            } catch (error) {
                console.error('Token error:', error);
                throw error;
            }
        }

        /**
         * Check if token is still valid, refresh if needed
         */
        async function ensureValidToken() {
            if (!accessToken || Date.now() >= tokenExpiresAt) {
                console.log('Token expired or missing, refreshing...');
                await getAccessToken();
            }
            return accessToken;
        }

        /**
         * Parse release year from album.release_date
         * Formats: "2023-05-15", "2023-05", "2023"
         */
        function parseReleaseYear(releaseDate) {
            if (!releaseDate) return null;
            const year = parseInt(releaseDate.substring(0, 4), 10);
            return isNaN(year) ? null : year;
        }

        /**
         * Search for Finnish hip-hop tracks from a specific year range
         */
        async function searchByYearRange(yearStart, yearEnd) {
            await ensureValidToken();

            const query = encodeURIComponent(`genre:finnish hip hop year:${yearStart}-${yearEnd}`);
            const url = `${SEARCH_ENDPOINT}?q=${query}&type=track&market=FI&limit=20`;

            console.log(`Searching: finnish hip hop ${yearStart}-${yearEnd}`);

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (!response.ok) {
                    console.error(`Search failed for ${yearStart}-${yearEnd}:`, response.status);
                    return [];
                }

                const data = await response.json();
                console.log(`Found ${data.tracks?.items?.length || 0} tracks for ${yearStart}-${yearEnd}`);

                return data.tracks?.items || [];
            } catch (e) {
                console.error(`Search error for ${yearStart}-${yearEnd}:`, e);
                return [];
            }
        }

        /**
         * Search for Finnish hip-hop tracks across 4 year ranges
         * Fetches 20 tracks from each decade/period for a total of ~80 tracks
         */
        async function searchFinnishHipHop() {
            await ensureValidToken();
            loadingMessage.textContent = 'Searching for Finnish hip-hop...';

            const seenIds = new Set();
            let fetchedTracks = [];

            // Fetch from 4 year ranges in parallel
            const yearRanges = [
                { start: 1990, end: 1999 },
                { start: 2000, end: 2009 },
                { start: 2010, end: 2019 },
                { start: 2020, end: 2024 }
            ];

            const results = await Promise.all(
                yearRanges.map(range => searchByYearRange(range.start, range.end))
            );

            // Merge results and deduplicate
            for (const trackList of results) {
                for (const track of trackList) {
                    if (!seenIds.has(track.id)) {
                        seenIds.add(track.id);
                        // Parse and attach the year to each track
                        track.releaseYear = parseReleaseYear(track.album?.release_date);
                        fetchedTracks.push(track);
                    }
                }
            }

            console.log(`Total tracks from year range search: ${fetchedTracks.length}`);

            // If year-based search didn't find enough, fall back to artist search
            if (fetchedTracks.length < 30) {
                loadingMessage.textContent = 'Loading more Finnish artists...';
                const artistTracks = await searchByArtists();

                for (const track of artistTracks) {
                    if (!seenIds.has(track.id)) {
                        seenIds.add(track.id);
                        track.releaseYear = parseReleaseYear(track.album?.release_date);
                        fetchedTracks.push(track);
                    }
                }
            }

            console.log(`Total unique tracks: ${fetchedTracks.length}`);

            if (fetchedTracks.length < 2) {
                throw new Error(`Only found ${fetchedTracks.length} tracks. Check console for API errors.`);
            }

            return fetchedTracks;
        }

        /**
         * Search by specific Finnish hip-hop artists
         * Extended list of popular Finnish rap artists
         */
        async function searchByArtists() {
            // Comprehensive list of Finnish hip-hop artists
            const artists = [
                'Cheek', 'JVG', 'Elastinen', 'Pyhimys', 'Paleface',
                'Fintelligens', 'Cledos', 'Ibe', 'Gettomasa', 'Costee',
                'Teflon Brothers', 'Heikki Kuula', 'Pikku G', 'Sini Sabotage',
                'Mikael Gabriel', 'SANNI', 'Antti Tuisku', 'Portion Boys'
            ];

            let allTracks = [];

            for (const artist of artists) {
                try {
                    // Search without artist: prefix for better results
                    const query = encodeURIComponent(artist);
                    const url = `${SEARCH_ENDPOINT}?q=${query}&type=track&market=FI&limit=15`;

                    const response = await fetch(url, {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.tracks && data.tracks.items) {
                            allTracks = allTracks.concat(data.tracks.items);
                            console.log(`Found ${data.tracks.items.length} tracks for ${artist}`);
                        }
                    }
                } catch (e) {
                    console.warn(`Failed to search for ${artist}:`, e);
                }

                // Small delay to avoid rate limiting
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            console.log(`Artist search found ${allTracks.length} tracks`);
            return allTracks;
        }

        /**
         * Filter tracks by year range
         */
        function filterTracksByYear(minYear, maxYear) {
            filteredTracks = allTracks.filter(track => {
                const year = track.releaseYear;
                return year !== null && year >= minYear && year <= maxYear;
            });

            updateTrackCountDisplay();
            return filteredTracks;
        }

        /**
         * Update the track count display
         */
        function updateTrackCountDisplay() {
            const trackCountEl = document.getElementById('trackCount');
            const count = filteredTracks.length;

            if (count < 2) {
                trackCountEl.textContent = `${count} tracks available - Laajenna aikav√§li√§`;
                trackCountEl.classList.add('warning');
                disableBattle(true);
            } else {
                trackCountEl.textContent = `${count} tracks available (${currentYearMin}-${currentYearMax})`;
                trackCountEl.classList.remove('warning');
                disableBattle(false);
            }
        }

        /**
         * Enable or disable battle functionality
         */
        function disableBattle(disabled) {
            const voteBtn1 = document.getElementById('voteBtn1');
            const voteBtn2 = document.getElementById('voteBtn2');
            const battleAgainBtn = document.getElementById('battleAgainBtn');

            if (disabled) {
                voteBtn1.disabled = true;
                voteBtn2.disabled = true;
                if (battleAgainBtn) battleAgainBtn.disabled = true;
            } else if (!battleEnded) {
                voteBtn1.disabled = false;
                voteBtn2.disabled = false;
                if (battleAgainBtn) battleAgainBtn.disabled = false;
            }
        }

        /**
         * Initialize the year range slider
         */
        function initYearSlider() {
            const sliderEl = document.getElementById('yearSlider');
            const yearRangeDisplay = document.getElementById('yearRangeDisplay');

            yearSlider = noUiSlider.create(sliderEl, {
                start: [1990, 2024],
                connect: true,
                step: 1,
                range: {
                    'min': 1990,
                    'max': 2024
                },
                format: {
                    to: value => Math.round(value),
                    from: value => Number(value)
                }
            });

            yearSlider.on('update', (values) => {
                currentYearMin = values[0];
                currentYearMax = values[1];
                yearRangeDisplay.textContent = `${currentYearMin} - ${currentYearMax}`;
            });

            yearSlider.on('change', (values) => {
                currentYearMin = values[0];
                currentYearMax = values[1];
                filterTracksByYear(currentYearMin, currentYearMax);

                // Start a new battle with the filtered tracks if we have enough
                if (filteredTracks.length >= 2) {
                    startNewBattle();
                }
            });
        }

        /**
         * Get two random tracks for battle
         * Ensures we don't pick the same track twice
         * Uses filteredTracks based on year range
         */
        function getRandomBattleTracks() {
            if (filteredTracks.length < 2) {
                throw new Error('Not enough tracks for battle');
            }

            const shuffled = [...filteredTracks].sort(() => Math.random() - 0.5);
            return [shuffled[0], shuffled[1]];
        }

        /**
         * Display a track in the battle arena
         */
        function displayTrack(track, position) {
            const album = document.getElementById(`album${position}`);
            const title = document.getElementById(`title${position}`);
            const artist = document.getElementById(`artist${position}`);
            const spotifyLink = document.getElementById(`spotifyLink${position}`);

            // Get largest album image
            const albumImage = track.album.images[0]?.url || '';

            album.src = albumImage;
            album.alt = `${track.name} album art`;
            title.textContent = track.name;
            artist.textContent = track.artists.map(a => a.name).join(', ');
            spotifyLink.href = track.external_urls.spotify;
        }

        /**
         * Start a new battle with two random tracks
         */
        function startNewBattle() {
            console.log('Starting new battle...');
            battleEnded = false;

            // Stop any playing audio
            stopAllAudio();

            // Get random tracks
            [currentTrack1, currentTrack2] = getRandomBattleTracks();
            console.log('Battle:', currentTrack1.name, 'vs', currentTrack2.name);

            // Display tracks
            displayTrack(currentTrack1, 1);
            displayTrack(currentTrack2, 2);

            // Reset UI
            document.getElementById('voteBtn1').disabled = false;
            document.getElementById('voteBtn2').disabled = false;
            document.getElementById('score1Container').classList.add('hidden');
            document.getElementById('score2Container').classList.add('hidden');
            document.getElementById('battleAgainContainer').classList.add('hidden');

            // Remove winner badges
            const existingBadges = document.querySelectorAll('.winner-badge, .tie-badge');
            existingBadges.forEach(badge => badge.remove());

            // Show battle section
            loadingSection.classList.add('hidden');
            errorSection.classList.add('hidden');
            battleSection.classList.remove('hidden');
        }

        /**
         * Handle user vote
         * Reveals winner based on Spotify popularity score (0-100)
         */
        function vote(choice) {
            if (battleEnded) return;
            battleEnded = true;

            console.log(`User voted for track ${choice}`);

            // Disable vote buttons
            document.getElementById('voteBtn1').disabled = true;
            document.getElementById('voteBtn2').disabled = true;

            // Stop audio
            stopAllAudio();

            // Get popularity scores
            const pop1 = currentTrack1.popularity;
            const pop2 = currentTrack2.popularity;

            console.log(`Popularity: ${currentTrack1.name} = ${pop1}, ${currentTrack2.name} = ${pop2}`);

            // Reveal scores with animation
            document.getElementById('score1').textContent = pop1;
            document.getElementById('score2').textContent = pop2;
            document.getElementById('score1Container').classList.remove('hidden');
            document.getElementById('score2Container').classList.remove('hidden');

            // Determine winner
            let winnerContainer = null;

            if (pop1 > pop2) {
                winnerContainer = document.getElementById('track1Container');
                addWinnerBadge(winnerContainer, 'WINNER!');
                triggerConfetti();
            } else if (pop2 > pop1) {
                winnerContainer = document.getElementById('track2Container');
                addWinnerBadge(winnerContainer, 'WINNER!');
                triggerConfetti();
            } else {
                // It's a tie!
                addTieBadge(document.getElementById('track1Container'));
                addTieBadge(document.getElementById('track2Container'));
            }

            // Update user stats
            const votedTrack = choice === 1 ? currentTrack1 : currentTrack2;
            const artistName = votedTrack.artists[0]?.name || 'Unknown';
            updateStats(artistName);

            // Show battle again button
            document.getElementById('battleAgainContainer').classList.remove('hidden');
        }

        /**
         * Add winner badge to track container
         */
        function addWinnerBadge(container, text) {
            const badge = document.createElement('div');
            badge.className = 'winner-badge';
            badge.textContent = text;
            container.appendChild(badge);
        }

        /**
         * Add tie badge to track container
         */
        function addTieBadge(container) {
            const badge = document.createElement('div');
            badge.className = 'tie-badge absolute top-4 right-4';
            badge.textContent = "It's a tie!";
            container.appendChild(badge);
        }

        /**
         * Trigger confetti celebration effect
         */
        function triggerConfetti() {
            const container = document.getElementById('confettiContainer');
            const colors = ['#003580', '#ffffff', '#ffd700', '#ff6b6b', '#4ade80', '#a78bfa'];

            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                    container.appendChild(confetti);

                    // Remove confetti after animation
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }

        /**
         * Setup click handlers to open Spotify links
         * Note: preview_url is no longer available for most tracks
         */
        function setupAudioControls() {
            const album1Container = document.getElementById('album1Container');
            const album2Container = document.getElementById('album2Container');

            album1Container.addEventListener('click', () => {
                if (currentTrack1 && currentTrack1.external_urls) {
                    window.open(currentTrack1.external_urls.spotify, '_blank');
                }
            });

            album2Container.addEventListener('click', () => {
                if (currentTrack2 && currentTrack2.external_urls) {
                    window.open(currentTrack2.external_urls.spotify, '_blank');
                }
            });
        }

        function stopAllAudio() {
            // No longer needed since we open Spotify links instead
        }

        /**
         * Info modal controls
         */
        function showInfoModal() {
            document.getElementById('infoModal').classList.remove('hidden');
        }

        function hideInfoModal(event) {
            // If called from backdrop click, event exists
            // If called from button, no event check needed
            document.getElementById('infoModal').classList.add('hidden');
        }

        /**
         * Keyboard shortcuts
         */
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (battleEnded) {
                    // Space or Enter to battle again
                    if (e.code === 'Space' || e.code === 'Enter') {
                        e.preventDefault();
                        startNewBattle();
                    }
                    return;
                }

                // Vote with 1 or 2
                if (e.key === '1') {
                    vote(1);
                } else if (e.key === '2') {
                    vote(2);
                }
            });
        }

        /**
         * User stats management (localStorage)
         */
        function loadStats() {
            try {
                const saved = localStorage.getItem('suomirap_stats');
                if (saved) {
                    userStats = JSON.parse(saved);
                }
            } catch (e) {
                console.warn('Could not load stats:', e);
            }
        }

        function saveStats() {
            try {
                localStorage.setItem('suomirap_stats', JSON.stringify(userStats));
            } catch (e) {
                console.warn('Could not save stats:', e);
            }
        }

        function updateStats(artistName) {
            userStats.battles++;
            userStats.artistVotes[artistName] = (userStats.artistVotes[artistName] || 0) + 1;
            saveStats();
            displayStats();
        }

        function displayStats() {
            document.getElementById('statBattles').textContent = userStats.battles;

            // Find most voted artist
            let maxVotes = 0;
            let favoriteArtist = '-';
            for (const [artist, votes] of Object.entries(userStats.artistVotes)) {
                if (votes > maxVotes) {
                    maxVotes = votes;
                    favoriteArtist = artist;
                }
            }
            document.getElementById('statFavorite').textContent = favoriteArtist;

            // Show stats panel after first battle
            if (userStats.battles > 0) {
                document.getElementById('statsPanel').classList.remove('hidden');
            }
        }

        /**
         * Show error state
         */
        function showError(title, message) {
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorMessage').textContent = message;
            loadingSection.classList.add('hidden');
            battleSection.classList.add('hidden');
            errorSection.classList.remove('hidden');
        }

        /**
         * Initialize the app
         */
        async function init() {
            console.log('Initializing SUOMIR√ÑP BATTLE...');

            // Load saved stats
            loadStats();
            displayStats();

            // Setup controls
            setupAudioControls();
            setupKeyboardShortcuts();

            try {
                // Get access token
                loadingMessage.textContent = 'Connecting to Spotify...';
                await getAccessToken();

                // Search for tracks from 4 year ranges
                loadingMessage.textContent = 'Loading Finnish hip-hop tracks...';
                allTracks = await searchFinnishHipHop();

                if (allTracks.length < 2) {
                    throw new Error('Could not find enough tracks');
                }

                console.log(`Loaded ${allTracks.length} tracks for battles`);

                // Initialize year slider
                initYearSlider();

                // Initial filter with full range
                filterTracksByYear(currentYearMin, currentYearMax);

                // Start first battle
                startNewBattle();

            } catch (error) {
                console.error('Initialization error:', error);
                showError(
                    'Could not connect to Spotify',
                    error.message || 'Please check your connection and try again.'
                );
            }
        }

        // Start the app when all resources (including external scripts) are loaded
        window.addEventListener('load', init);
    </script>
</body>
</html>
